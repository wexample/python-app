#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
APP_ROOT="${APP_ROOT:-$ROOT}"
AM_DIR="$ROOT/.wex/python/app_manager"
VENV="$AM_DIR/.venv"
PY="$VENV/bin/python3"

if [ ! -x "$PY" ]; then
  python3 -m venv "$VENV"
  "$PY" -m pip install -U pip wheel
fi

# Always install local app package (editable) to reflect latest changes
(cd "$AM_DIR" && "$PY" -m pip install -e .)

# Prefer local core in editable mode if available; fallback to PyPI dep
CORE_DIR="$ROOT/../../wex-core"
if [ -d "$CORE_DIR" ]; then
  "$PY" -m pip install -e "$CORE_DIR"
fi

export APP_ROOT
exec "$PY" -m app_manager "$@"
